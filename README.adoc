= ‚úàÔ∏è TP : Cas Yak-√†-Partir - S√©curisation & D√©veloppement
:author: Professeur SIO
:revdate: 2025-05-31
:toc: left
:toc-title: Sommaire
:icons: font
:source-highlighter: highlightjs
:sectnums:

== üéØ Contexte de la mission

Vous int√©grez l'√©quipe de d√©veloppement de **Breizh-SN**.
Votre mission consiste √† s√©curiser et unifier les applications de l'agence de voyage *Yak-√†-Partir*.
Ce projet regroupe les volets techniques et organisationnels de l'√©tude de cas :

* **Java** : Gestion des utilisateurs (Client lourd).
* **SQL** : Unification des bases de donn√©es & RGPD.
* **Web (PHP)** : Protection CSRF & Analyse de logs.

[IMPORTANT]
====
**Consignes de rendu :**
. Le code doit √™tre fonctionnel dans ce projet IntelliJ.
. Les r√©ponses aux questions th√©oriques (Analyses, RGPD, EBIOS...) doivent √™tre r√©dig√©es dans un fichier nomm√© `RAPPORT.md` ou `RAPPORT.adoc` √† la racine du projet.
====

== üìÅ Dossier A : Application Java (S√©curit√© Applicative)

**Objectif** : Impl√©menter les r√®gles de s√©curit√© pour les mots de passe et les habilitations dans le package `fr.yak.holy`.

=== üìù Analyse & R√©flexion
_(√Ä r√©diger dans votre rapport)_

. **Documentation (Question A1.2)**
* Proposez une documentation au format **Javadoc** pour la m√©thode `modifierMdp` de la classe `Utilisateur`.

. **Sc√©nario de risque (Question A3.2)**
* D√©crivez un sc√©nario de risque concret exploitant l'absence de restriction d'acc√®s aux √©l√©ments du menu de l'application (avant la mise en place des habilitations).
* _Indice : Que se passe-t-il si un stagiaire acc√®de au menu "Comptabilit√©" ?_

=== üõ†Ô∏è T√¢ches Techniques

. **Analyse du code (Question A1.1)**
* Localisez la classe : `src/main/java/fr/yak/holy/modele/Utilisateur.java`.
* Corrigez les erreurs de nommage (Conventions Java) dans les m√©thodes existantes (ex: `ancienMdp`).

. **Impl√©mentation (Questions A2.1 & A2.2)**
* Compl√©tez la m√©thode `modifierMdp` pour respecter la politique de s√©curit√© :
** Longueur >= 12 caract√®res.
** Au moins 1 majuscule, 3 minuscules, 4 chiffres, 1 caract√®re sp√©cial.
** Le mot de passe ne doit pas avoir d√©j√† √©t√© utilis√© (V√©rification de l'historique).

. **Pr√©paration √† la persistance (Question A2.3)**
* Dans `Utilisateur.java`, cr√©ez une m√©thode `public String genererRequeteUpdate()` qui retourne la requ√™te SQL (sous forme de cha√Æne de caract√®res) n√©cessaire pour mettre √† jour le mot de passe d'un utilisateur en fonction de son ID.
* _Note : Utilisez des points d'interrogation `?` pour les param√®tres (Requ√™te pr√©par√©e)._

. **Validation (Question A3.1)**
* Ouvrez la classe de test : `src/test/java/test/UtilisateurTest.java`.
* Vous devez **√©crire la m√©thode de test** `verifModifierMdp()` (laiss√©e vide ou absente).
* Votre test doit v√©rifier 3 cas via des assertions (`assertTrue` / `assertFalse`) :
** Le rejet d'un mot de passe trop simple (Echec).
** Le rejet d'un mot de passe d√©j√† utilis√© dans l'historique (Echec).
** L'acceptation d'un mot de passe valide (Succ√®s).
* Lancez ensuite les tests (Clic droit -> Run 'UtilisateurTest').

[NOTE]
====
L'objectif est d'obtenir une barre **verte** (Tests Passed).
Tant que la barre est rouge, soit votre test est mal √©crit, soit votre m√©thode m√©tier `modifierMdp` ne respecte pas les consignes.
====

== üìÅ Dossier B : Base de Donn√©es (Int√©grit√© & RGPD)

**Objectif** : Fusionner les bases, g√©rer le consentement RGPD et emp√™cher les fraudes.

=== üìù Analyse & R√©flexion
_(√Ä r√©diger dans votre rapport)_

. **Classification des donn√©es (Question B1.1)**
* R√©alisez un tableau (DICP ou simple liste) recensant les **donn√©es personnelles** et les **donn√©es sensibles** pr√©sentes dans la base de donn√©es (Voir Sch√©ma `script_yak.sql`).

. **Communication Utilisateur (Question B1.3)**
* R√©digez le corps du courriel √† envoyer aux clients pour les avertir de la fusion des bases et r√©colter leur consentement pour le publipostage (Lien vers formulaire).

. **Preuve de consentement (Question B1.4)**
* Proposez une solution technique d√©taill√©e pour conserver une trace int√®gre du consentement (Logs sign√©s, Blockchain, Tiers de confiance...).

. **Analyse de Risques EBIOS (Question B2.1)**
* Justifiez le niveau de gravit√© (1 √† 4) pour les risques suivants :
** **R1** : Injection SQL permettant de modifier un acompte.
** **R2** : Injection SQL permettant de r√©duire le prix sous le seuil de rentabilit√©.

=== üõ†Ô∏è T√¢ches Techniques

. **Initialisation**
* Configurez la connexion √† votre base locale dans l'onglet *Database* d'IntelliJ.
* Ex√©cutez `sql_database/script_yak.sql`.

. **Modification RGPD (Question B1.2)**
* √âcrivez et ex√©cutez la requ√™te `ALTER TABLE` pour ajouter le champ `accordPubli` (bool√©en, d√©faut FAUX).

. **S√©curisation par Trigger (Questions B2.2 & B2.3)**
* Compl√©tez le trigger `before_insert_contrat_voyage` pour bloquer les contrats inf√©rieurs √† **75‚Ç¨ / jour / personne**.

[TIP]
====
Pour tester votre trigger, tentez d'ins√©rer un contrat frauduleux via la console SQL :
`INSERT INTO Contrat_Voyage ...`
Vous devez voir appara√Ætre votre message d'erreur personnalis√© (`SIGNAL SQLSTATE`).
====

== üìÅ Dossier C : Web & PHP (Failles & Incidents)

**Objectif** : S√©curiser l'application contre le CSRF et analyser les incidents de s√©curit√©.

=== üìù Analyse & R√©flexion
_(√Ä r√©diger dans votre rapport)_

. **Compr√©hension CSRF (Question C1.1)**
* Expliquez bri√®vement le principe de la faille CSRF et comment le jeton (token) prot√®ge l'application.

. **Analyse de Logs (Question C2.1)**
* Voici un extrait du fichier de journalisation :
+
----
[21:41:18] NOTICE: utilisateur AllanG : erreur de connexion
[21:41:20] WARNING: utilisateur : essai de connexion avec champs vides
[21:41:24] NOTICE: utilisateur RichardP : erreur de connexion
[21:41:24] NOTICE: utilisateur RichardP : erreur de connexion
[21:41:24] NOTICE: utilisateur RichardP : erreur de connexion
[21:41:26] NOTICE: utilisateur AllanG : s‚Äôest connect√© correctement
[21:41:26] NOTICE: utilisateur RichardP : erreur de connexion
----
* Identifiez les √©v√©nements suspects.
* √âmettez une hypoth√®se sur l'attaque en cours concernant l'utilisateur `RichardP`.

. **D√©sactivation de compte (Question C2.3)**
* Proposez une solution technique (MCD ou Algorithme) pour d√©sactiver automatiquement un compte apr√®s 5 √©checs successifs.

=== üõ†Ô∏è T√¢ches Techniques

. **Audit et Correction (Mission C1)**
* Ouvrez `web_app/modifMdp.php`.
* Constatez l'absence de protection.
* Impl√©mentez la protection par **Token Anti-CSRF** :
** G√©n√©ration en session.
** Ajout du champ cach√© `<input type="hidden">` dans le formulaire.
** V√©rification stricte dans `traitement.php`.

[WARNING]
====
Pensez √† configurer l'interpr√©teur PHP dans IntelliJ (_Settings -> PHP_) pour profiter de la d√©tection d'erreurs.
====

== üêò Lancer l'application Web avec Laragon

. Lancez **Laragon**.
. Cliquez sur le bouton **Racine** (Root) pour ouvrir le dossier `C:\laragon\www`.
. Cr√©ez un dossier nomm√© `yak`.
. Copiez-y tout le contenu du dossier `web_app` de ce projet.
. Dans Laragon, cliquez sur **Tout Lancer** (Start All).
. Laragon devrait afficher une notification : _"Project: yak"_.
. Ouvrez votre navigateur et allez sur : **http://yak.test**