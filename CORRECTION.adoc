= üîë CORRECTION : TP Yak-√†-Partir
:author: Professeur SIO
:revdate: 2025-05-31
:toc: left
:toc-title: Sommaire de la Correction
:icons: font
:source-highlighter: highlightjs
:sectnums:

== üìÅ Dossier A : Application Java (S√©curit√©)

=== A1 & A2. Impl√©mentation de la classe `Utilisateur`

[source,java]
.Fichier : src/main/java/fr/yak/holy/modele/Utilisateur.java
----
package fr.yak.holy.modele;

import java.time.LocalDate;
import java.util.ArrayList;

public class Utilisateur {
    // ... attributs (inchang√©s) ...

    // --- CORRECTION Q A1.1 : Renommage (camelCase) ---
    public boolean estAncienMdp(String motDePasse) {
        for (MotDePasse mdp : lesAnciensMdp) {
            if (mdp.getValMdp().equals(motDePasse)) return true;
        }
        return false;
    }

    // --- CORRECTION Q A1.2 : Javadoc ---
    /**
     * Tente de modifier le mot de passe.
     * V√©rifie la complexit√© (12 car, 1 Maj, 3 min, 4 chiffres, 1 sp√©)
     * et l'unicit√© par rapport √† l'historique.
     * @param nouveauMdp Le nouveau mot de passe candidat.
     * @return true si la modification est accept√©e, false sinon.
     */
    // --- CORRECTION Q A2.1 & A2.2 : Logique m√©tier ---
    public boolean modifierMdp(String nouveauMdp) {
        // 1. V√©rification complexit√©
        if (!verifierMdp(nouveauMdp)) return false;

        // 2. V√©rification historique
        if (estAncienMdp(nouveauMdp)) return false;

        // 3. Archivage
        this.lesAnciensMdp.add(new MotDePasse(this.motDePasse, LocalDate.now()));
        
        // 4. Mise √† jour
        this.motDePasse = nouveauMdp;
        return true;
    }

    private boolean verifierMdp(String mdp) {
        int nbMaj = 0, nbMin = 0, nbChiffre = 0, nbSpe = 0;
        for (char c : mdp.toCharArray()) {
            if (Character.isUpperCase(c)) nbMaj++;
            else if (Character.isLowerCase(c)) nbMin++;
            else if (Character.isDigit(c)) nbChiffre++;
            else if (!Character.isLetterOrDigit(c)) nbSpe++;
        }
        // R√®gle : 12 car, 1 Maj, 3 Min, 4 Chiffres, 1 Sp√©cial
        return mdp.length() >= 12 && nbMaj >= 1 && nbMin >= 3 && nbChiffre >= 4 && nbSpe >= 1;
    }

    // --- CORRECTION Q A2.3 : Requ√™te SQL ---
    public String genererRequeteUpdate() {
        return "UPDATE Client SET mdp = ? WHERE idCli = ?";
    }
    
    // --- CORRECTION Q A3.3a : Getter Habilitation ---
    public int getNiveauHabilitation() {
        return this.sonHabilitation.getNiveau();
    }
}
----

=== A3.1. Test Unitaire

[source,java]
.Fichier : src/test/java/test/UtilisateurTest.java
----
// ... imports ...
class UtilisateurTest {
    Utilisateur unUtilisateur;

    @BeforeEach
    void init() {
        Habilitation habil = new Habilitation("ma01", 1, "master", true, false, true, false);
        unUtilisateur = new Utilisateur("U001", "Nom", "Pre", "login", "M1ue@uiT455n", habil);
        
        // Simulation historique (Attention : Mots de passe valides √† 4 chiffres !)
        unUtilisateur.modifierMdp("Lae99_Mat00!"); // Devient l'actuel
        unUtilisateur.modifierMdp("NouveauPass1234!"); // Devient l'actuel, "Lae99..." passe en archive
    }

    @Test
    void verifModifierMdp() {
        // 1. √âchec : Trop simple
        assertFalse(unUtilisateur.modifierMdp("toto"), "Doit refuser MDP faible");

        // 2. √âchec : D√©j√† utilis√© ("Lae99_Mat00!" est dans les archives gr√¢ce au init())
        assertFalse(unUtilisateur.modifierMdp("Lae99_Mat00!"), "Doit refuser ancien MDP");

        // 3. Succ√®s : Valide (12 chars, 1M, 3m, 4c, 1s)
        assertTrue(unUtilisateur.modifierMdp("Valide2024!ok"), "Doit accepter MDP fort");
    }
}
----



=== A3.2. Analyse de Risque (Menu)
* **Risque :** √âl√©vation de privil√®ges (ou acc√®s ill√©gitime).
* **Sc√©nario :** Un stagiaire (niveau 0) se connecte. L'interface charge tous les menus. Le stagiaire clique sur "Comptabilit√©". M√™me si le code m√©tier bloquait l'action, il peut voir des donn√©es sensibles affich√©es par d√©faut ou tenter des actions non pr√©vues.
* **Correction (A3.3b) :** `if (user.getNiveauHabilitation() < 2) btnCompta.setVisible(false);`

== üìÅ Dossier B : Base de Donn√©es (SQL & RGPD)

=== B1.1. Classification des donn√©es
[cols="1,1,1"]
|===
|Donn√©e |Type |Sensibilit√©

|Nom, Pr√©nom, Email
|Donn√©e Personnelle (PII)
|Faible (Standard)

|Mot de passe
|Donn√©e Technique
|**Critique** (Doit √™tre hach√©)

|Accord Publipostage
|Donn√©e Personnelle
|Moyenne (Consentement explicite)
|===

=== A3.3. S√©curisation de l'Interface (Habilitations)

**1. C√¥t√© Mod√®le (Question A3.3a)**
Dans la classe `Utilisateur`, on expose le niveau d'habilitation via une d√©l√©gation :

[source,java]
----
// Dans Utilisateur.java
public int getNiveauHabilitation() {
    // On d√©l√®gue la question √† l'objet Habilitation
    return this.sonHabilitation.getNiveau();
}
----

**2. C√¥t√© Vue / Swing (Question A3.3b)**
Dans la classe principale de l'interface (ex: `FenetrePrincipale.java` ou `AppliHoly.java`), on masque les √©l√©ments sensibles au chargement de la fen√™tre :

[source,java]
----
// Dans le constructeur ou la m√©thode d'initialisation de la fen√™tre
public void appliquerHabilitations(Utilisateur userConnecte) {
    
    // R√®gle : Seul le niveau 2 (Responsable) ou plus peut voir l'admin
    if (userConnecte.getNiveauHabilitation() < 2) {
        
        // On cache le bouton (ou le menu) "Gestion Administrative"
        this.btnGestionAdmin.setVisible(false);
        
        // Alternative : On le grise seulement
        // this.btnGestionAdmin.setEnabled(false); 
    }
}
----

=== B1.2. Modification de structure (RGPD)
[source,sql]
----
ALTER TABLE Client 
ADD accordPubli BOOLEAN DEFAULT FALSE;
----

=== B1.3 & B1.4. Consentement
* **Email :** Doit √™tre clair, expliquer la finalit√© (fusion), et fournir un lien "Opt-in" (Cocher pour accepter). Pas de case pr√©-coch√©e !
* **Preuve :** Stocker le timestamp, l'adresse IP, et l'ID de la version des CGU accept√©es dans une table `Log_Consentement` immuable.

=== B2. Trigger Anti-Fraude

[source,sql]
----
DELIMITER $$
CREATE TRIGGER before_insert_contrat_voyage
BEFORE INSERT ON Contrat_Voyage
FOR EACH ROW
BEGIN
    -- D√©claration des variables
    DECLARE duree INT;
    DECLARE seuil DECIMAL(10,2);
    
    -- R√©cup√©ration de la dur√©e via le Devis
    SELECT nbJours INTO duree 
    FROM Devis_Voyage WHERE idDevis = NEW.idDevis;
    
    -- Calcul du seuil : 75‚Ç¨ * nbJours * nbParticipants
    SET seuil = 75 * duree * NEW.nbParticipants;
    
    -- V√©rification Anti-Fraude
    IF NEW.montantAPayer < seuil THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'FRAUDE : Montant inf√©rieur au seuil de rentabilit√© (75‚Ç¨/j/p)';
    END IF;
END $$
DELIMITER ;
----

== üìÅ Dossier C : Web (PHP & CSRF)

=== C1.1. Principe CSRF
Le **Cross-Site Request Forgery** force le navigateur d'un utilisateur connect√© √† effectuer une action √† son insu (ex: changer son mot de passe) via un lien pi√©g√© sur un autre site.
* **Contre-mesure :** Le Jeton (Token). Le serveur g√©n√®re un code al√©atoire unique en session. Le formulaire doit renvoyer ce code. L'attaquant ne connaissant pas ce code, sa fausse requ√™te √©chouera.

=== C1. Code PHP S√©curis√©

**1. Formulaire (`modifMdp.php`)**
[source,php]
----
<?php
session_start();
// G√©n√©ration du token
if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
?>
<form method="POST" action="traitement.php">
    <input type="hidden" name="token" value="<?php echo $_SESSION['csrf_token']; ?>">
    </form>
----

**2. Traitement (`traitement.php`)**
[source,php]
----
<?php
session_start();
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!isset($_POST['token']) || !hash_equals($_SESSION['csrf_token'], $_POST['token'])) {
        die("Erreur CSRF : Jeton invalide !");
    }
    // ... suite du traitement (Update SQL) ...
}
?>
----

=== C2.1. Analyse des Logs (Incident RichardP)

. **Observations**
* Utilisateur `RichardP` : 5 √©checs cons√©cutifs en moins de 2 secondes (21:41:24 - 21:41:26).

. **Hypoth√®se**
* La vitesse d'ex√©cution prouve qu'il s'agit d'un **automate** (script).
* C'est une attaque par **Force Brute** (dictionnaire).

. **Conclusion**
* La ligne `[21:41:28] ... s‚Äôest connect√© correctement` montre que l'attaque a **r√©ussi**. Le compte est pirat√©.

=== C2.3. Algorithme D√©sactivation
* **Principe :** Ajouter un champ `nbEchecs` et `dateDernierEchec` dans la table Utilisateur.
* **Algorithme :**
    1. Si `login` OK mais `mdp` KO : `nbEchecs++`.
    2. Si `nbEchecs >= 5` : Bloquer le compte (flag `estActif = false` ou blocage temporaire de 15 min).
    3. Si connexion OK : Remettre `nbEchecs = 0`.
