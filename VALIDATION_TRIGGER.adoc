= ğŸ§ª Validation des Triggers SQL (Dossier B)
:author: Yak-Ã -Partir Quality Assurance
:icons: font
:toc: left
:toc-title: Plan de Test SQL
:source-highlighter: highlightjs
:sectnums:

== ğŸ¯ Objectif

Ce document dÃ©crit la procÃ©dure de validation du dÃ©clencheur (Trigger) `before_insert_contrat_voyage`.
L'objectif est de vÃ©rifier que les rÃ¨gles mÃ©tier anti-fraude et les rÃ¨gles de gestion sont bien appliquÃ©es par la base de donnÃ©es.

[IMPORTANT]
====
Ces tests doivent Ãªtre exÃ©cutÃ©s dans la **Console Database** d'IntelliJ (ou Laragon/HeidiSQL) aprÃ¨s avoir jouÃ© le script `script_yak.sql`.
====

== âš™ï¸ PrÃ©paration des DonnÃ©es

Avant de tester, nous devons nous assurer que la table est vide et que les devis de rÃ©fÃ©rence existent.

.ExÃ©cutez ce bloc pour initialiser l'environnement de test :
[source,sql]
----
USE Yak_Voyages;

-- 1. Nettoyage de la table des contrats pour partir d'une page blanche
DELETE FROM Contrat_Voyage;

-- 2. CrÃ©ation des devis de rÃ©fÃ©rence (si inexistants)
-- Devis 1 : "Safari Kenya" (10 jours)
-- Devis 2 : "Weekend BZH" (2 jours)
INSERT IGNORE INTO Devis_Voyage (idDevis, intituleVoyage, nbJours, nbParticipants) VALUES
(1, 'Safari Kenya', 10, 2),
(2, 'Weekend BZH', 2, 2);
----

== âŒ Test 1 : Tentative de Fraude (Prix Trop Bas)

**RÃ¨gle Ã  tester :** Le montant du contrat doit Ãªtre supÃ©rieur Ã  **75â‚¬ par jour et par personne**.

* **Contexte :** Devis nÂ°1 (10 jours) pour 2 personnes.
* **Seuil CalculÃ© :** 10 jours * 2 pers * 75â‚¬ = **1500â‚¬**.
* **Action :** Tentative d'insertion d'un contrat Ã  **1400â‚¬**.

[source,sql]
----
INSERT INTO Contrat_Voyage (montantAPayer, acompte, nbParticipants, idDevis)
VALUES (1400, 500, 2, 1);
----

.RÃ©sultat Attendu
[CAUTION]
====
La requÃªte doit Ã©chouer avec l'erreur SQL **10002**.
Message : _"Alerte fraude : Le montant du contrat est infÃ©rieur au seuil de rentabilitÃ© (75â‚¬/j/p)."_
====

== âŒ Test 2 : RÃ¨gle de DurÃ©e (Non-rÃ©gression)

**RÃ¨gle Ã  tester :** La durÃ©e du voyage doit Ãªtre d'au moins 3 jours.

* **Contexte :** Devis nÂ°2 (2 jours).
* **Action :** Tentative d'insertion d'un contrat valide financiÃ¨rement, mais trop court.

[source,sql]
----
INSERT INTO Contrat_Voyage (montantAPayer, acompte, nbParticipants, idDevis)
VALUES (1000, 300, 2, 2);
----

.RÃ©sultat Attendu
[CAUTION]
====
La requÃªte doit Ã©chouer avec l'erreur SQL **10001**.
Message : _"Le devis validÃ© par le contrat est d'une durÃ©e infÃ©rieure Ã  la durÃ©e minimale autorisÃ©e"_
====

== âœ… Test 3 : Cas Valide (SuccÃ¨s)

**Objectif :** VÃ©rifier qu'un contrat honnÃªte est acceptÃ©.

* **Contexte :** Devis nÂ°1 (10 jours) pour 2 personnes.
* **Seuil :** 1500â‚¬.
* **Action :** Insertion d'un contrat Ã  **2000â‚¬**.

[source,sql]
----
INSERT INTO Contrat_Voyage (montantAPayer, acompte, nbParticipants, idDevis)
VALUES (2000, 500, 2, 1);
----

.RÃ©sultat Attendu
[NOTE]
====
La requÃªte doit rÃ©ussir.
Message : _1 row affected_ (Une ligne affectÃ©e).
====

== ğŸ•µï¸ VÃ©rification Finale

Pour prouver que le trigger a correctement filtrÃ© les entrÃ©es, nous inspectons le contenu final de la table.

[source,sql]
----
SELECT * FROM Contrat_Voyage;
----

.RÃ©sultat Attendu
* La table ne doit contenir **qu'une seule ligne** (celle du contrat Ã  2000â‚¬).
* Les tentatives Ã  1400â‚¬ et sur le devis court ne doivent pas apparaÃ®tre.

---
*Fin du protocole de validation SQL.*